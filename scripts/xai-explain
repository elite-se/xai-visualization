#!/bin/env python

import argparse
from xai_visualization.config import Config
from tensorflow import keras
import numpy as np
import shap
from xai_visualization.train import prepare_dataset
from xai_visualization.util.load_data import feature_names
import tensorflow as tf

def explain(model):
    data_train, labels_train, data_test, labels_test = prepare_dataset("data")
    #explainer = shap.GradientExplainer(model, data_train[:100])
    #explainer = shap.KernelExplainer(model, data_train[:100]) # Also not working
    explainer = shap.DeepExplainer(model, data_train[:100]) # Currently is not supported in TF2: https://github.com/slundberg/shap/issues/885#issuecomment-564778328
    shap_values = explainer.shap_values(data_train[:10])

    shap.summary_plot(shap_values, data_train[:10], 
    class_names=[str(i) for i in range(18)],
    feature_names=feature_names)
    #shap.force_plot(explainer.expected_value[0], shap_values[0][0,:], data_train[0,:], link="logit")



if __name__ == "__main__":
    parser = argparse.ArgumentParser("explain the decisions of the model")
    parser.add_argument("--model", type=str, help="the path to the model", required=True)
    parser.add_argument("--config", type=str, help="the config", required=False)
    args = parser.parse_args()

    tf.compat.v1.disable_eager_execution()
    
    model = keras.models.load_model(args.model)

    explain(model)